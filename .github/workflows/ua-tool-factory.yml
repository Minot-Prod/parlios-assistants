name: UA Tool Factory

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      name:
        description: tool slug (ex: value-prop)
        required: true
      title:
        description: Titre lisible
        required: false
      desc:
        description: Description courte
        required: false

jobs:
  ship:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '/ua ship tool'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Parse inputs
        id: parse
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            NAME="${{ github.event.inputs.name }}"
            TITLE="${{ github.event.inputs.title }}"
            DESC="${{ github.event.inputs.desc }}"
          else
            BODY="$(jq -r '.comment.body' "$GITHUB_EVENT_PATH")"
            NAME=$(echo "$BODY" | sed -n 's#.*tool \([a-z0-9\-]\+\).*#\1#p' | head -n1)
            TITLE=$(echo "$BODY" | sed -n 's#.*--title "\([^"]*\)".*#\1#p' | head -n1)
            DESC=$(echo "$BODY" | sed -n 's#.*--desc "\([^"]*\)".*#\1#p' | head -n1)
          fi
          [ -z "$NAME" ] && echo "No tool slug found" && exit 1
          echo "name=$NAME"   >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "desc=$DESC"   >> $GITHUB_OUTPUT

      - name: Generate tool files
        run: |
          node .github/scripts/ua_tool_factory.mjs \
            --name "${{ steps.parse.outputs.name }}" \
            --title "${{ steps.parse.outputs.title }}" \
            --desc "${{ steps.parse.outputs.desc }}"

      - name: Commit changes
        id: commit
        run: |
          BR="ua/tool-${{ steps.parse.outputs.name }}-${GITHUB_RUN_NUMBER}"
          git config user.name  "ua-bot"
          git config user.email "ua-bot@users.noreply.github.com"
          git checkout -b "$BR"
          git add -A
          git commit -m "feat(tool): ${{ steps.parse.outputs.name }} scaffold (Function + page)"
          git push -u origin "$BR"
          echo "branch=$BR" >> $GITHUB_OUTPUT

      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.commit.outputs.branch }}
          title: "feat(tool): ${{ steps.parse.outputs.name }} ready"
          body: |
            Generated by **UA Tool Factory**.

            - Tool: `${{ steps.parse.outputs.name }}`
            - Title: ${{ steps.parse.outputs.title }}
            - Desc:  ${{ steps.parse.outputs.desc }}

            Merge to deploy to production at https://www.parlios.fr/tools/${{ steps.parse.outputs.name }}
          draft: false

      - name: Comment back (issues)
        if: github.event_name == 'issue_comment'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ✅ **UA Tool Factory** a généré `${{ steps.parse.outputs.name }}` et ouvert une PR.
            La preview Netlify apparaîtra sur la PR une fois le build terminé.
